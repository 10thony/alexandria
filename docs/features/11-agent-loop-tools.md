# Agent Loop & Tools

## Overview

The Chef AI Agent processes user requests by calling language models and executing tools to build applications. The agent uses a tool-based approach where it can edit files, view files, deploy applications, install packages, and look up documentation.

## Key Components

### Agent Components

- **`chef-agent/ChatContextManager.ts`** - Context management for agent
- **`chef-agent/message-parser.ts`** - Message parsing and artifact extraction
- **`chef-agent/prompts/`** - System prompts and guidelines
- **`chef-agent/tools/`** - Tool definitions

### Tools

- **`tools/edit.ts`** - File editing tool
- **`tools/view.ts`** - File viewing tool
- **`tools/deploy.ts`** - Deployment tool
- **`tools/npmInstall.ts`** - Package installation tool
- **`tools/lookupDocs.ts`** - Documentation lookup
- **`tools/addEnvironmentVariables.ts`** - Environment variable management
- **`tools/getConvexDeploymentName.ts`** - Convex deployment info

## Implementation Details

### Agent Loop

The agent follows this flow:

1. **User Message**: User sends message
2. **Context Preparation**: Context prepared with relevant files and history
3. **LLM Call**: Message sent to language model
4. **Tool Calls**: Model returns tool calls
5. **Tool Execution**: Tools executed in sequence
6. **Response Generation**: Model generates response with artifacts
7. **Artifact Processing**: Artifacts parsed and applied
8. **Deployment**: Optional deployment triggered

### Context Management

The `ChatContextManager` manages:

- **Relevant Files**: Files most relevant to current task
- **Message History**: Recent message history
- **Context Size**: Context optimized for token limits
- **File Caching**: LRU cache for file access

### Tool System

Tools are defined with:

- **Description**: Tool description for LLM
- **Parameters**: Zod schema for parameters
- **Execution**: Tool execution logic

### Available Tools

#### Edit Tool

Edits files by replacing text:

```typescript
{
  path: string,  // File path
  old: string,   // Text to replace
  new: string    // Replacement text
}
```

#### View Tool

Reads file contents:

```typescript
{
  path: string,
  view_range?: [number, number]  // Optional line range
}
```

#### Deploy Tool

Deploys application:

```typescript
{}  // No parameters
```

#### npmInstall Tool

Installs packages:

```typescript
{
  packages: string  // Space-separated package names
}
```

## Code References

### Chat Context Manager
```28:51:chef-agent/ChatContextManager.ts
export class ChatContextManager {
  assistantMessageCache: WeakMap<UIMessage, ParsedAssistantMessage> = new WeakMap();
  messageSizeCache: WeakMap<UIMessage, number> = new WeakMap();
  partSizeCache: WeakMap<UIMessagePart, number> = new WeakMap();
  messageIndex: number = -1;
  partIndex: number = -1;

  constructor(
    private getCurrentDocument: () => EditorDocument | undefined,
    private getFiles: () => FileMap,
    private getUserWrites: () => Map<AbsolutePath, number>,
  ) {}

  /**
   * Reset the context manager state. This should be called when switching
   * between subchats to prevent stale message indices from causing errors.
   */
  reset(): void {
    this.assistantMessageCache = new WeakMap();
    this.messageSizeCache = new WeakMap();
    this.partSizeCache = new WeakMap();
    this.messageIndex = -1;
    this.partIndex = -1;
  }
```

### Edit Tool
```21:24:chef-agent/tools/edit.ts
export const editTool: Tool = {
  description: editToolDescription,
  parameters: editToolParameters,
};
```

### Deploy Tool
```19:22:chef-agent/tools/deploy.ts
export const deployTool: Tool = {
  description: deployToolDescription,
  parameters: z.object({}),
};
```

### npmInstall Tool
```24:27:chef-agent/tools/npmInstall.ts
export const npmInstallTool: Tool = {
  description: npmInstallToolDescription,
  parameters: npmInstallToolParameters,
};
```

## System Prompts

The agent uses several system prompts:

- **System Prompt**: Core agent instructions
- **Convex Guidelines**: Convex-specific development guidelines
- **Solution Constraints**: Constraints on solutions
- **Formatting Instructions**: Code formatting rules
- **Output Instructions**: Output format requirements

## Artifact Processing

Artifacts are code blocks generated by the model:

1. **Artifact Extraction**: Artifacts extracted from messages
2. **File Mapping**: Files mapped to paths
3. **Action Execution**: Actions executed to apply changes
4. **File Updates**: Files updated in WebContainer

## Related Features

- **Chat Interface**: User interaction with agent
- **Workbench**: File editing and preview
- **WebContainer**: File system operations
- **Project Deployment**: Deployment execution

