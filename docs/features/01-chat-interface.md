# Chat Interface

## Overview

The Chat Interface is the primary user interaction point in Chef. It provides a conversational interface where users communicate with the AI agent to build applications. The interface handles message display, input, streaming responses, model selection, and various chat management features.

## Key Components

### Main Components

- **`Chat.tsx`** - Main chat component that orchestrates the chat experience
- **`BaseChat.client.tsx`** - Base chat UI component with layout and message rendering
- **`MessageInput.tsx`** - Text input component for user messages
- **`Messages.client.tsx`** - Component for rendering message list
- **`AssistantMessage.tsx`** - Renders AI assistant messages
- **`UserMessage.tsx`** - Renders user messages
- **`ToolCall.tsx`** - Displays tool call information
- **`Artifact.tsx`** - Renders code artifacts generated by the agent
- **`CodeBlock.tsx`** - Syntax-highlighted code blocks
- **`Markdown.tsx`** - Markdown rendering for messages

## Implementation Details

### Message Flow

1. **User Input**: User types message in `MessageInput` component
2. **Message Submission**: Message sent via `useChat` hook from `@ai-sdk/react`
3. **Streaming**: Response streams back from server via Remix action
4. **Parsing**: Messages parsed using `useMessageParser` hook
5. **Display**: Messages rendered in `Messages` component with proper formatting

### State Management

```typescript
// Chat state managed through:
- useChat hook for message state
- workbenchStore for artifact and action state
- chatStore for UI visibility state
- description store for chat title
```

### Key Features

#### 1. Streaming Responses
- Real-time token streaming from AI model
- Progress indicators during streaming
- Tool call status display
- Action status updates

#### 2. Model Selection
- Support for multiple providers:
  - Anthropic (Claude)
  - OpenAI (GPT models)
  - Google (Gemini)
  - XAI (Grok)
- Auto mode for automatic provider selection
- Model preference stored in localStorage

#### 3. Message History
- Messages stored in Convex database
- Compressed storage for efficiency
- Message retrieval and restoration
- Subchat support for conversation branching

#### 4. Rewind Functionality
- Rewind to previous message states
- Restore chat to earlier point
- Subchat-specific rewinding

#### 5. API Key Management
- User API key support
- Preference settings (always use vs quota exhausted)
- Multi-provider API key storage
- Automatic fallback to Convex tokens

#### 6. Error Handling
- Retry logic with exponential backoff
- Error message display
- Quota exhaustion handling
- Missing API key warnings

### Context Management

The `ChatContextManager` class manages:
- Relevant file selection for context
- Message history truncation
- Prompt character counting
- Context size optimization

### Tool Integration

The chat interface integrates with various tools:
- **Edit Tool**: File editing operations
- **View Tool**: File reading operations
- **Deploy Tool**: Deployment operations
- **npmInstall Tool**: Package installation
- **lookupDocs Tool**: Documentation lookup

## Code References

### Main Chat Component
```94:104:app/components/chat/Chat.tsx
export const Chat = memo(
  ({
    initialMessages,
    partCache,
    storeMessageHistory,
    initializeChat,
    isReload,
    hadSuccessfulDeploy,
    subchats,
  }: ChatProps) => {
```

### Message Input Component
```93:98:app/components/chat/MessageInput.tsx
export const MessageInput = memo(function MessageInput({
  chatStarted,
  isStreaming,
  sendMessageInProgress,
  onStop,
  onSend
```

### Base Chat Component
```72:94:app/components/chat/BaseChat.client.tsx
export const BaseChat = React.forwardRef<HTMLDivElement, BaseChatProps>(
  (
    {
      messageRef,
      scrollRef,
      showChat = true,
      chatStarted = false,
      streamStatus = 'ready',
      currentError,
      onSend,
      onStop,
      sendMessageInProgress,
      messages,
      actionAlert,
      clearAlert,
      toolStatus,
      terminalInitializationOptions,
      disableChatMessage,
      modelSelection,
      setModelSelection,
      onRewindToMessage,
      subchats,
    },
    ref,
  ) => {
```

## Related Features

- **Message Management & Storage**: How messages are stored and retrieved
- **Agent Loop & Tools**: How the AI agent processes requests
- **Subchats**: Conversation branching functionality
- **Model Selection**: Provider and model selection logic

